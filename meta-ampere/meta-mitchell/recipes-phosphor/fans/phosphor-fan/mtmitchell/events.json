[
  {
    // Hold fans at the given target when a number of fans are missing.
    "name": "fan(s) missing",
    "groups": [
      {
        "name": "fan inventory",
        "interface": "xyz.openbmc_project.Inventory.Item",
        "property": { "name": "Present" }
      }
    ],
    "triggers": [
      {
        "class": "init",
        "method": "get_properties"
      },
      {
        "class": "signal",
        "signal": "properties_changed"
      }
    ],
    "actions": [
      {
        "name": "count_state_before_target",
        "count": 1,
        "state": false,
        "target": 255
      }
    ]
  },
  {
    // Hold fans at the given target when a number of rotors are nonfunctional.
    "name": "fan rotor(s) faulted",
    "groups": [
      {
        "name": "fan0 rotor inventory",
        "interface": "xyz.openbmc_project.State.Decorator.OperationalStatus",
        "property": { "name": "Functional" }
      },
      {
        "name": "fan1 rotor inventory",
        "interface": "xyz.openbmc_project.State.Decorator.OperationalStatus",
        "property": { "name": "Functional" }
      },
      {
        "name": "fan2 rotor inventory",
        "interface": "xyz.openbmc_project.State.Decorator.OperationalStatus",
        "property": { "name": "Functional" }
      },
      {
        "name": "fan4 rotor inventory",
        "interface": "xyz.openbmc_project.State.Decorator.OperationalStatus",
        "property": { "name": "Functional" }
      },
      {
        "name": "fan5 rotor inventory",
        "interface": "xyz.openbmc_project.State.Decorator.OperationalStatus",
        "property": { "name": "Functional" }
      }
    ],
    "triggers": [
      {
        "class": "init",
        "method": "get_properties"
      },
      {
        "class": "signal",
        "signal": "properties_changed"
      }
    ],
    "actions": [
      {
        "name": "count_state_before_target",
        "count": 1,
        "state": false,
        "target": 255
      }
    ]
  },
  {
    // Hold fans at the given target when any critical service
    // is not running for 5 seconds.
    "name": "service(s) missing",
    "groups": [
      {
        "name": "fan inventory",
        "interface": "xyz.openbmc_project.Inventory.Item",
        "property": { "name": "Present" }
      },
      {
        "name": "CPU temps",
        "interface": "xyz.openbmc_project.Sensor.Value",
        "property": { "name": "Value" }
      }
    ],
    "triggers": [
      {
        "class": "init",
        "method": "name_has_owner"
      },
      {
        "class": "signal",
        "signal": "name_owner_changed"
      }
    ],
    "actions": [
      {
        "name": "call_actions_based_on_timer",
        "timer": {
          "interval": 5000000,
          "type": "oneshot"
        },
        "actions": [
          {
            "name": "set_target_on_missing_owner",
            "groups": [
              {
                  "name": "CPU temps",
                  "interface": "xyz.openbmc_project.Sensor.Value",
                  "property": { "name": "Value" }
              }
            ],
            "target": 255
          }
        ]
      }
    ]
  },
  {
    // Set a raised fan floor when any temperature sensor is nonfunctional
    "name": "Nonfunctional temperature sensors",
    "groups": [
      {
        "name": "CPU temps",
        "interface": "xyz.openbmc_project.State.Decorator.OperationalStatus",
        "property": { "name": "Functional" }
      }
    ],
    "triggers": [
      {
        "class": "signal",
        "signal": "properties_changed"
      },
      {
        "class": "signal",
        "signal": "interfaces_added"
      },
      {
        "class": "init",
        "method": "get_properties"
      }
    ],
    "actions": [
      {
        "name": "count_state_before_target",
        "count": 1,
        "state": false,
        "target": 255
      }
    ]
  },
  {
    // Collect group temperatures each iteration the repeating timer expires
    "name": "Fan control timer loop",
    "groups": [
      {
        "name": "CPU temps",
        "interface": "xyz.openbmc_project.Sensor.Value",
        "property": { "name": "Value" }
      }
    ],
    "triggers": [
      {
        "class": "timer",
        "type": "repeating",
        "interval": 1000000,
        "preload_groups": true
      }
    ],
    "actions": [
      {
        "name": "set_net_increase_target",
        "groups": [
          {
            "name": "CPU temps",
            "interface": "xyz.openbmc_project.Sensor.Value",
            "property": { "name": "Value" }
          }
        ],
        "delta": 0.1,
        "state_parameter_name": "cpu_temp_param"
      },
      {
        "name": "set_net_decrease_target",
        "groups": [
          {
            "name": "CPU temps",
            "interface": "xyz.openbmc_project.Sensor.Value",
            "property": { "name": "Value" }
          }
        ],
        "delta": 3,
        "state_parameter_name": "cpu_temp_param"
      }
    ]
  },
  {
    "name": "Set offset parameter",
    "groups": [
      {
        "name": "CPU temps",
        "interface": "xyz.openbmc_project.Sensor.Value",
        "property": { "name": "Value" }
      }
    ],
    "triggers": [
      {
        "class": "init",
        "method": "get_properties"
      },
      {
        "class": "signal",
        "signal": "interfaces_added"
      },
      {
        "class": "timer",
        "type": "repeating",
        "interval": 500000,
        "preload_groups": true
      }
    ],
    "actions": [
      {
        "name": "set_parameter_from_group_max",
        "parameter_name": "cpu_temp_param",
        "modifier": {
          "operator": "less_than",
          "default_value": 24.0,
          "value": [
            { "arg_value": 8.1, "parameter_value": 255.0 },
            { "arg_value": 9.1, "parameter_value": 243.0 },
            { "arg_value": 10.1, "parameter_value": 230.0 },
            { "arg_value": 11.1, "parameter_value": 217.0 },
            { "arg_value": 12.1, "parameter_value": 204.0 },
            { "arg_value": 13.1, "parameter_value": 192.0 },
            { "arg_value": 14.1, "parameter_value": 179.0 },
            { "arg_value": 15.1, "parameter_value": 166.0 },
            { "arg_value": 25.1, "parameter_value": 115.0 },
            { "arg_value": 30.1, "parameter_value": 90.0 },
            { "arg_value": 35.1, "parameter_value": 64.0 },
            { "arg_value": 104.1, "parameter_value": 64.0 }
          ]
        }
      }
    ]
  },
  {
    "name": "Fan floors",
    "groups": [
      {
        "name": "CPU temps",
        "interface": "xyz.openbmc_project.Sensor.Value",
        "property": { "name": "Value" }
      }
    ],
    "triggers": [
      {
        "class": "init",
        "method": "get_properties"
      },
      {
        "class": "signal",
        "signal": "properties_changed"
      },
      {
        "class": "signal",
        "signal": "interfaces_added"
      },
      {
        "class": "parameter",
        "parameter": "cpu_temp_param"
      }
    ],
    "actions": [
      {
        "name": "mapped_floor",
        "key_group": "CPU temps",
        "fan_floors": [
          {
            "key": 200.0,
            "default_floor": 255.0,
            "group": "CPU temps",
            "floors": [
              {
                "parameter": "cpu_temp_param",
                "floors": [
                    { "value": 64.0, "floor": 64.0 },
                    { "value": 90.0, "floor": 90.0 },
                    { "value": 115.0, "floor": 115.0 },
                    { "value": 141.0, "floor": 141.0 },
                    { "value": 166.0, "floor": 166.0 },
                    { "value": 179.0, "floor": 179.0 },
                    { "value": 192.0, "floor": 192.0 },
                    { "value": 204.0, "floor": 204.0 },
                    { "value": 217.0, "floor": 217.0 },
                    { "value": 230.0, "floor": 230.0 },
                    { "value": 242.0, "floor": 242.0 },
                    { "value": 255.0, "floor": 255.0 }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
]
