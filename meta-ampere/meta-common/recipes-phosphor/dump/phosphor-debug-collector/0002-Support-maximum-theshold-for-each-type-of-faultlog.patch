From 5f4dc90486949d9c8a11b23a0f98e56d0a97e09f Mon Sep 17 00:00:00 2001
From: Dung Cao <dung@os.amperecomputing.com>
Date: Fri, 13 Jan 2023 08:42:37 +0000
Subject: [PATCH 1/2] Support maximum theshold for each type of faultlog

Support maximum theshold entry for CPER type and CrashDump type.

When the number of fault log entries exceed the maximum limit,
remove the entry and remove the file that stored the additional
data.

When the number of CPER/Crashdump entries exceed the maximum limit,
remove the file that stored the additional data.

Signed-off-by: Dung Cao <dung@os.amperecomputing.com>
---
 dump_manager_faultlog.cpp | 138 ++++++++++++++++++++++++++++++++++----
 dump_manager_faultlog.hpp |  21 +++++-
 faultlog_dump_entry.hpp   |   4 +-
 meson.build               |   9 +++
 meson_options.txt         |  17 ++++-
 5 files changed, 171 insertions(+), 18 deletions(-)

diff --git a/dump_manager_faultlog.cpp b/dump_manager_faultlog.cpp
index 750ca58..60fb32f 100644
--- a/dump_manager_faultlog.cpp
+++ b/dump_manager_faultlog.cpp
@@ -45,20 +45,13 @@ sdbusplus::message::object_path
 {
     FaultDataType entryType = FaultDataType::Crashdump;
     std::string primaryLogIdStr;
+    std::string additionalTypeStr;
 
     log<level::INFO>("In dump_manager_faultlog.cpp createDump");
+    getAndCheckCreateDumpParams(params, entryType, primaryLogIdStr,
+                                additionalTypeStr);
 
-    getAndCheckCreateDumpParams(params, entryType, primaryLogIdStr);
-
-    // To stay within the limit of MAX_NUM_FAULT_LOG_ENTRIES we need to remove
-    // an entry from the fault log map to make room for creating a new entry
-    if (entries.size() == MAX_NUM_FAULT_LOG_ENTRIES)
-    {
-        // Save the earliest fault log entry to a saved entries map (if
-        // it qualifies to be saved), and remove it from the main fault
-        // log entries map.
-        saveEarliestEntry();
-    }
+    checkThresholdFaultLog(entryType, additionalTypeStr);
 
     // Get the originator id and type from params
     std::string originatorId;
@@ -116,7 +109,7 @@ sdbusplus::message::object_path
                 std::filesystem::file_size(faultLogFilePath), faultLogFilePath,
                 phosphor::dump::OperationStatus::Completed,
                 originatorId, originatorType, entryType,
-                primaryLogIdStr, *this, &entries)));
+                primaryLogIdStr, additionalTypeStr, *this, &entries)));
     }
     catch (const std::invalid_argument& e)
     {
@@ -324,7 +317,7 @@ void Manager::registerCperLogMatch()
 
 void Manager::getAndCheckCreateDumpParams(
     const phosphor::dump::DumpCreateParams& params, FaultDataType& entryType,
-    std::string& primaryLogIdStr)
+    std::string& primaryLogIdStr, std::string& additionalTypeName)
 {
     using InvalidArgument =
         sdbusplus::xyz::openbmc_project::Common::Error::InvalidArgument;
@@ -488,6 +481,125 @@ void Manager::saveEarliestEntry()
     entries.erase(earliestEntryId);
 }
 
+void Manager::checkThresholdFaultLog(FaultDataType entryType,
+                                     std::string &additionalTypeStr)
+{
+    if (faultLogSize == MAX_TOTAL_FAULT_LOG_ENTRIES)
+    {
+        FaultDataType delType;
+        removeEarliestEntry(delType);
+        switch (delType) {
+        case FaultDataType::CPER:
+            cperLogSize--;
+            break;
+        case FaultDataType::Crashdump:
+            if (additionalTypeStr.empty())
+                crashdumpSize--;
+            else
+            {
+                /* OEM */
+            }
+            break;
+        default:
+            log<level::ERR>("Incorrect FaultLog Entry Type\n");
+            elog<InternalFailure>();
+            break;
+        }
+    }
+    else
+        faultLogSize++;
+
+    if (entryType == FaultDataType::CPER)
+    {
+        if (cperLogSize == MAX_TOTAL_CPER_LOG_ENTRIES)
+            removeEarliestDataEntry(entryType);
+        else
+            cperLogSize++;
+    }
+    else if (entryType == FaultDataType::Crashdump)
+    {
+        if (additionalTypeStr.empty())
+        {
+            if (crashdumpSize == MAX_TOTAL_CRASHDUMP_ENTRIES)
+                removeEarliestDataEntry(entryType);
+            else
+                crashdumpSize++;
+        }
+        else
+        {
+            /* OEM */
+        }
+    }
+    else
+    {
+        log<level::ERR>("Incorrect entry type \n");
+        elog<InternalFailure>();
+    }
+}
+
+void Manager::removeEarliestDataEntry(FaultDataType type)
+{
+    for ( auto it = entries.begin(); it != entries.end(); ++it  )
+    {
+        auto secondPtr = it->second.get();
+        FaultDataType entryType =
+                dynamic_cast<faultlog::Entry*>(secondPtr)->type();
+        std::string primaryLogId =
+                dynamic_cast<faultlog::Entry*>(secondPtr)->primaryLogId();
+        if (entryType == type)
+        {
+            // Remove fault log file
+            std::string faultLogFilePath;
+            switch (entryType) {
+            case FaultDataType::CPER:
+                faultLogFilePath = std::string(CPER_LOG_PATH) + primaryLogId;
+                break;
+            case FaultDataType::Crashdump:
+                faultLogFilePath = std::string(CRASHDUMP_LOG_PATH) + primaryLogId;
+                break;
+            default:
+                log<level::ERR>("Incorrect FaultLog Entry Type\n");
+                elog<InternalFailure>();
+                break;
+            }
+            if (std::filesystem::exists(faultLogFilePath.c_str()))
+            {
+                std::filesystem::remove(faultLogFilePath.c_str());
+                break;
+            }
+        }
+    }
+}
+
+void Manager::removeEarliestEntry(FaultDataType &delType)
+{
+    auto it = entries.begin();
+    auto secondPtr = it->second.get();
+    FaultDataType entryType =
+            dynamic_cast<faultlog::Entry*>(secondPtr)->type();
+    std::string primaryLogId =
+            dynamic_cast<faultlog::Entry*>(secondPtr)->primaryLogId();
+    delType = entryType;
+    std::string faultLogFilePath;
+    switch (entryType) {
+    case FaultDataType::CPER:
+        faultLogFilePath = std::string(CPER_LOG_PATH) + primaryLogId;
+        break;
+    case FaultDataType::Crashdump:
+        faultLogFilePath = std::string(CRASHDUMP_LOG_PATH) + primaryLogId;
+        break;
+    default:
+        log<level::ERR>("Incorrect FaultLog Entry Type\n");
+        elog<InternalFailure>();
+        break;
+    }
+    if (std::filesystem::exists(faultLogFilePath.c_str()))
+    {
+        std::filesystem::remove(faultLogFilePath.c_str());
+    }
+    entries.erase(it);
+}
+
 } // namespace faultlog
 } // namespace dump
 } // namespace phosphor
diff --git a/dump_manager_faultlog.hpp b/dump_manager_faultlog.hpp
index 84c1aea..ea8fab7 100644
--- a/dump_manager_faultlog.hpp
+++ b/dump_manager_faultlog.hpp
@@ -64,6 +64,9 @@ class Manager :
         }
 
         registerFaultLogMatches();
+        faultLogSize = 0;
+        cperLogSize = 0;
+        crashdumpSize = 0;
     }
 
     void restore() override
@@ -87,8 +90,7 @@ class Manager :
 
   private:
     static constexpr uint32_t MAX_NUM_FAULT_LOG_ENTRIES =
-        MAX_TOTAL_FAULT_LOG_ENTRIES - MAX_NUM_SAVED_CRASHDUMP_ENTRIES -
-        MAX_NUM_SAVED_CPER_LOG_ENTRIES;
+            MAX_TOTAL_CPER_LOG_ENTRIES + MAX_TOTAL_CRASHDUMP_ENTRIES;
 
     /** @brief Map of saved CPER log entry dbus objects based on entry id */
     std::map<uint32_t, std::unique_ptr<phosphor::dump::Entry>>
@@ -98,6 +100,10 @@ class Manager :
     std::map<uint32_t, std::unique_ptr<phosphor::dump::Entry>>
         savedCrashdumpEntries;
 
+    uint32_t faultLogSize;
+    uint32_t cperLogSize;
+    uint32_t crashdumpSize;
+
     /** @brief Path to the dump file*/
     std::string dumpDir;
 
@@ -120,10 +126,12 @@ class Manager :
      *  @param[out] entryType - Log entry type (corresponding to type of data in
      * primary fault data log)
      *  @param[out] primaryLogIdStr - Id of primary fault data log
+     *  @param[out] additionalTypeName - OEM format of a entryType
      */
     void getAndCheckCreateDumpParams(
         const phosphor::dump::DumpCreateParams& params,
-        FaultDataType& entryType, std::string& primaryLogIdStr);
+        FaultDataType& entryType, std::string& primaryLogIdStr,
+        std::string& additionalTypeName);
 
     /** @brief Generate the current timestamp, adjusting as needed to ensure an
      * increase compared to the last fault log entry's timestamp
@@ -143,6 +151,13 @@ class Manager :
      *  then it's simply deleted from the main fault log entries map.
      */
     void saveEarliestEntry();
+
+    void removeEarliestDataEntry(FaultDataType type);
+
+    void removeEarliestEntry(FaultDataType &delType);
+
+    void checkThresholdFaultLog(FaultDataType type,
+                                std::string &additionalTypeStr);
 };
 
 } // namespace faultlog
diff --git a/faultlog_dump_entry.hpp b/faultlog_dump_entry.hpp
index cafc1cf..64bf05f 100644
--- a/faultlog_dump_entry.hpp
+++ b/faultlog_dump_entry.hpp
@@ -62,7 +62,8 @@ class Entry : virtual public EntryIfaces, virtual public phosphor::dump::Entry
         const std::filesystem::path& file,
         phosphor::dump::OperationStatus status, std::string originatorId,
         originatorTypes originatorType, FaultDataType entryType,
-        const std::string& primaryLogIdStr, phosphor::dump::Manager& parent,
+        const std::string& primaryLogIdStr, const std::string& additionalTypeStr,
+        phosphor::dump::Manager& parent,
         std::map<uint32_t, std::unique_ptr<phosphor::dump::Entry>>* parentMap) :
         EntryIfaces(bus, objPath.c_str(), EntryIfaces::action::defer_emit),
         phosphor::dump::Entry(bus, objPath.c_str(), dumpId, timeStamp, fileSize,
@@ -71,6 +72,7 @@ class Entry : virtual public EntryIfaces, virtual public phosphor::dump::Entry
     {
         type(entryType);
         primaryLogId(primaryLogIdStr);
+        additionalTypeName(additionalTypeStr);
     }
 
     /** @brief Delete this d-bus object.
diff --git a/meson.build b/meson.build
index aa0caf6..b713e0d 100644
--- a/meson.build
+++ b/meson.build
@@ -130,12 +130,21 @@ conf_data.set_quoted('FAULTLOG_DUMP_PATH', get_option('FAULTLOG_DUMP_PATH'),
 conf_data.set_quoted('CPER_LOG_PATH', get_option('CPER_LOG_PATH'),
                       description : 'File system path containing CPER logs'
                     )
+conf_data.set_quoted('CRASHDUMP_LOG_PATH', get_option('CRASHDUMP_LOG_PATH'),
+                      description : 'File system path containing CrashDump logs'
+                    )
 conf_data.set('CPER_LOG_ID_STRING_LEN', get_option('CPER_LOG_ID_STRING_LEN'),
                       description : 'Length of GUID string identifying a CPER log'
                     )
 conf_data.set('MAX_TOTAL_FAULT_LOG_ENTRIES', get_option('MAX_TOTAL_FAULT_LOG_ENTRIES'),
                       description : 'Maximum number of fault log entries including those specially saved'
                     )
+conf_data.set('MAX_TOTAL_CPER_LOG_ENTRIES', get_option('MAX_TOTAL_CPER_LOG_ENTRIES'),
+                      description : 'Maximum number of CPER entries'
+                    )
+conf_data.set('MAX_TOTAL_CRASHDUMP_ENTRIES', get_option('MAX_TOTAL_CRASHDUMP_ENTRIES'),
+                      description : 'Maximum number of CrashDump entries'
+                    )
 conf_data.set('MAX_NUM_SAVED_CRASHDUMP_ENTRIES', get_option('MAX_NUM_SAVED_CRASHDUMP_ENTRIES'),
                       description : 'Maximum number of specially saved crashdump entries'
                     )
diff --git a/meson_options.txt b/meson_options.txt
index 873766b..57781d9 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -108,7 +108,12 @@ option('FAULTLOG_DUMP_OBJ_ENTRY', type : 'string',
       )
 
 option('CPER_LOG_PATH', type : 'string',
-        value : '/run/bmcweb/redfish/v1/Systems/system/LogServices/',
+        value : '/var/lib/faultlogs/cper/',
+        description : 'File system path containing CPER logs'
+      )
+
+option('CRASHDUMP_LOG_PATH', type : 'string',
+        value : '/var/lib/faultlogs/crashdump/',
         description : 'File system path containing CPER logs'
       )
 
@@ -122,6 +127,16 @@ option('MAX_TOTAL_FAULT_LOG_ENTRIES', type : 'integer',
         description : 'Maximum number of fault log entries including those specially saved'
       )
 
+option('MAX_TOTAL_CPER_LOG_ENTRIES', type : 'integer',
+        value : 100,
+        description : 'Maximum number of CPER entries'
+      )
+      
+option('MAX_TOTAL_CRASHDUMP_ENTRIES', type : 'integer',
+        value : 10,
+        description : 'Maximum number of CrashDump entries'
+      )
+
 option('MAX_NUM_SAVED_CRASHDUMP_ENTRIES', type : 'integer',
         value : 1,
         description : 'Maximum number of specially saved crashdump entries'
-- 
2.17.1

