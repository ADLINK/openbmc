From 797c106473088a11afcc1842ceb031dcb9ba6a69 Mon Sep 17 00:00:00 2001
From: Thang Tran <thuutran@amperecomputing.com>
Date: Fri, 15 Sep 2023 14:06:33 +0700
Subject: [PATCH 5/6] dbus-sdr: support reading OEM SEL logs

This commit supports reading OEM SEL record type in range 0xC0-0xDF and
0xE0-0xFF.

Tested:
  Request to show SEL logs, OEM SEL log is shown.

Signed-off-by: Thang Tran <thuutran@amperecomputing.com>
---
 dbus-sdr/storagecommands.cpp | 41 ++++++++++++++++++++++++++++++++++++
 1 file changed, 41 insertions(+)

diff --git a/dbus-sdr/storagecommands.cpp b/dbus-sdr/storagecommands.cpp
index 113e5bf..ba4fa94 100644
--- a/dbus-sdr/storagecommands.cpp
+++ b/dbus-sdr/storagecommands.cpp
@@ -1186,6 +1186,47 @@ ipmi::RspType<uint16_t,                   // Next Record ID
             systemEventType{timestamp, generatorID, evmRev, sensorType,
                             sensorNum, eventType, eventDir, eventData});
     }
+    else if (recordType >=
+				   dynamic_sensors::ipmi::sel::oemTsEventFirst &&
+			   recordType <=
+				   dynamic_sensors::ipmi::sel::oemTsEventLast)
+    {
+			// Get the timestamp
+			std::tm timeStruct = {};
+			std::istringstream entryStream(entryTimestamp);
+
+			uint32_t timestamp = ipmi::sel::invalidTimeStamp;
+			if (entryStream >>
+			    std::get_time(&timeStruct, "%Y-%m-%dT%H:%M:%S")) {
+				timestamp = std::mktime(&timeStruct);
+			}
+
+			// Only keep the bytes that fit in the record
+			std::array<uint8_t,
+				   dynamic_sensors::ipmi::sel::oemTsEventSize>
+				eventData{};
+			std::copy_n(eventDataBytes.begin(),
+				    std::min(eventDataBytes.size(),
+					     eventData.size()),
+				    eventData.begin());
+
+			return ipmi::responseSuccess(
+				nextRecordID, recordID, recordType,
+				oemTsEventType{ timestamp, eventData });
+	}
+    else if (recordType >= dynamic_sensors::ipmi::sel::oemEventFirst)
+    {
+			// Only keep the bytes that fit in the record
+			std::array<uint8_t, dynamic_sensors::ipmi::sel::oemEventSize>
+				eventData{};
+			std::copy_n(eventDataBytes.begin(),
+				    std::min(eventDataBytes.size(),
+					     eventData.size()),
+				    eventData.begin());
+
+			return ipmi::responseSuccess(nextRecordID, recordID,
+						     recordType, eventData);
+	}
 
     return ipmi::responseUnspecifiedError();
 }
-- 
2.34.1

