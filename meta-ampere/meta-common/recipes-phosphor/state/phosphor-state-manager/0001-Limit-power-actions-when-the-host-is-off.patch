From a0f3a130a434adbb33acfcb095a36fb4bb3c10b6 Mon Sep 17 00:00:00 2001
From: Thang Tran <thuutran@amperecomputing.com>
Date: Mon, 25 Oct 2021 14:36:33 +0700
Subject: [PATCH] Limit power actions when the host is off

When the host is off, power reset/soft/cycle should not affect.
This commit supports that limitation.

Tested:
        1. Power off the host.
        2. Try power soft, power reset, power cycle.
        3. These action should not affect.

Signed-off-by: Thu Ba Nguyen <tbnguyen@amperecomputing.com>
Signed-off-by: Thang Tran    <thuutran@amperecomputing.com>
---
 host_state_manager.cpp | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/host_state_manager.cpp b/host_state_manager.cpp
index 8d35a07..d246845 100644
--- a/host_state_manager.cpp
+++ b/host_state_manager.cpp
@@ -132,7 +132,18 @@ void Host::determineInitialState()
 void Host::executeTransition(Transition tranReq)
 {
     auto sysdUnit = SYSTEMD_TARGET_TABLE.find(tranReq)->second;
-
+    auto hostState = server::Host::currentHostState();
+
+    if ((sysdUnit == HOST_STATE_SOFT_POWEROFF_TGT ||
+        sysdUnit == HOST_STATE_REBOOT_TGT ||
+        sysdUnit == HOST_STATE_WARM_REBOOT ||
+        sysdUnit == HOST_STATE_FORCE_WARM_REBOOT) &&
+        !(stateActive(HOST_STATE_POWERON_MIN_TGT) || (HostState::Running == hostState)) &&
+        !stateActive(HOST_STATE_QUIESCE_TGT))
+    {
+        std::remove("/run/openbmc/host@0-request");
+        return;
+    }
     auto method = this->bus.new_method_call(SYSTEMD_SERVICE, SYSTEMD_OBJ_PATH,
                                             SYSTEMD_INTERFACE, "StartUnit");
 
-- 
2.30.0

